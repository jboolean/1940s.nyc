service: fourtiesnyc
package:
  individually: false

provider:
  name: aws
  runtime: nodejs16.x
  stage: production
  region: us-east-1
  iam:
    role:
      statements:
        - Effect: Allow
          Action: 
            - s3:*
          Resource: "*"
plugins:
  - serverless-plugin-select
  - serverless-offline
  - serverless-plugin-typescript
  - serverless-domain-manager

functions:
  app:
    handler: appHandler.handler
    timeout: 10
    events: 
      - http:
          path: /{proxy+}
          method: ANY
    environment:
      STAGE: ${sls:stage}
      DB_HOST: ${ssm:/${self:service}-${sls:stage}-db-host}
      DB_PORT: ${ssm:/${self:service}-${sls:stage}-db-port}
      DB_USERNAME: ${ssm:/${self:service}-${sls:stage}-db-username}
      DB_PASSWORD: ${ssm:/${self:service}-${sls:stage}-db-password}
      DB_DATABASE: ${ssm:/${self:service}-${sls:stage}-db-database}
      STRIPE_SK: ${ssm:/${self:service}-${sls:stage}-stripe-sk}
      RECAPTCHA_SK: ${ssm:/${self:service}-${sls:stage}-recaptcha-sk}
      POSTMARK_TOKEN: ${ssm:/${self:service}-${sls:stage}-postmark-token}
      FRONTEND_BASE_URL: ${ssm:/${self:service}-${sls:stage}-frontend-base-url}
      JWT_SECRET: ${ssm:/${self:service}-${sls:stage}-jwt-secret}
  convertImage:
    stages:
      - production
    handler: convertImage.handler
    events:
      - s3:
          bucket: ${self:custom.bucket}
          event: s3:ObjectCreated:*
          rules:
            - prefix: originals/
  deleteImage:
    stages:
      - production
    handler: convertImage.deletionHandler
    events:
      - s3:
          bucket: ${self:custom.bucket}
          event: s3:ObjectRemoved:*
          rules:
            - prefix: originals/

custom:
  bucket: fourties-photos
  domain:
    production: api.1940s.nyc
    staging: api.staging.1940s.nyc
    dev: dev.1940s.nyc
  domainEnabled:
    production: true
    staging: true
    dev: false
  customDomain:
    enabled: ${self:custom.domainEnabled.${sls:stage}}
    domainName: ${self:custom.domain.${sls:stage}}
    basePath: ''
    stage: ${sls:stage}
    createRoute53Record: true
